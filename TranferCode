<%@ Page Language="C#" AutoEventWireup="true" CodeBehind="AnnualReport1.aspx.cs" Inherits="CRM.AnnualReport1" %>

<!DOCTYPE html>
<html lang="zh-TW">
<head runat="server">
<meta charset="utf-8" />
<title>年度查詢報表</title>

<!-- Bootstrap & jQuery -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<!-- jQuery UI：日期選擇器 -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<style>
    /* ---------- Sticky ---------- */
    thead tr.totals-row   th{position:sticky;top:0;   z-index:4;background:#fff;color:#007bff;}
    thead tr:nth-child(2) th{position:sticky;top:48px;z-index:3;background:#f2f2f2;}
    thead tr:nth-child(3) th{position:sticky;top:96px;z-index:2;background:#fafafa;}
    thead tr:nth-child(4) th{position:sticky;top:144px;z-index:1;background:#fff;}

    /* 固定欄位色 */
    .fc-blank{background:#fff!important;}
    .fc      {background:#f2f2f2!important;}

    /* 年度色塊 */
    .year-0{background:#92D050;}
    .year-1{background:#00B0F0;}
    .year-2{background:#FFC000;}
    .year-3{background:#A9A9A9;}

    /* 捲動容器 */
    .h-scroll-wrapper{overflow-x:auto;width:100%;}
    .table-responsive{max-height:700px;overflow-y:auto;overflow-x:hidden;}

    /* 格寬限制 & 換行 */
    .table-wrapper th,
    .table-wrapper td{
        min-width:60px;
        max-width:150px;
        white-space:normal;
        word-break:break-word;
    }

    /* 其他表格設定 */
    .table thead th{vertical-align:bottom;border-bottom:0;}
    .table-bordered td,.table-bordered th{border:0;}
    .table-sm td,.table-sm th{padding:.75rem;}

    /* 固定欄寬 */
    .w120{width:120px;} .w100{width:100px;} .w80{width:80px;} .w60{width:60px;}

    /* 兩表固定 layout，確保寬度同步 */
    #headerTable,#bodyTable{table-layout:fixed;width:100%;}
</style>
</head>
<body>
<form id="form1" runat="server" class="container-fluid my-3">

<!-- ===== 查詢條件 ===== -->
<div class="card mb-3">
  <div class="card-header">查詢條件</div>
  <div class="card-body">

    <!-- 第一列 -->
    <div class="form-row">
      <div class="form-group col-md-2">
        <label>Department</label>
        <select id="ddlDept" class="form-control">
          <option value="">All</option><option>S100</option><option>S200</option>
        </select>
      </div>
      <div class="form-group col-md-2">
        <label>Business</label>
        <select id="ddlBiz" class="form-control">
          <option value="">All</option><option>Alice</option><option>Bob</option>
        </select>
      </div>
      <div class="form-group col-md-2">
        <label>Region</label>
        <select id="ddlRegion" class="form-control">
          <option value="">All</option>
          <option value="TW">Taiwan</option><option value="CN">China + HK</option><option value="JP">Japan</option>
        </select>
      </div>
      <div class="form-group col-md-3">
        <label>Year (多選)</label>
        <div>
          <label class="mr-2"><input type="checkbox" name="year" value="2022"/>2022</label>
          <label class="mr-2"><input type="checkbox" name="year" value="2023"/>2023</label>
          <label class="mr-2"><input type="checkbox" name="year" value="2024"/>2024</label>
          <label class="mr-2"><input type="checkbox" name="year" value="2025"/>2025</label>
        </div>
      </div>
      <div class="form-group col-md-3">
        <label>Customer</label>
        <select id="ddlCustomer" class="form-control">
          <option value="">All</option><option>VI</option><option>EPS</option>
        </select>
      </div>
    </div>

    <!-- 第二列 -->
    <div class="form-row">
      <div class="form-group col-md-2">
        <label>Cust&nbsp;Item</label><input id="txtCustItem" class="form-control"/>
      </div>
      <div class="form-group col-md-2">
        <label>Substrate</label>
        <select id="ddlSubstrate" class="form-control">
          <option value="">All</option><option>SubA</option><option>SubB</option>
        </select>
      </div>
      <div class="form-group col-md-2">
        <label>Products&nbsp;type</label>
        <select id="ddlProductType" class="form-control">
          <option value="">All</option><option>GaN</option><option>SiC</option>
        </select>
      </div>
      <div class="form-group col-md-2">
        <label>Ship&nbsp;to</label><input id="txtShipTo" class="form-control" placeholder="e.g. Taiwan"/>
      </div>
      <div class="form-group col-md-2">
        <label>Real&nbsp;Date</label><input id="txtRealDate" class="form-control datepicker" placeholder="yyyy/MM/dd"/>
      </div>
      <div class="form-group col-md-1">
        <label>Status</label>
        <select id="ddlStatus" class="form-control">
          <option value="">All</option><option>Open</option><option>Closed</option>
        </select>
      </div>
      <div class="form-group col-md-1">
        <label>Order&nbsp;Type</label>
        <select id="ddlOrderType" class="form-control">
          <option value="">All</option><option>3x01</option><option>3x02</option>
        </select>
      </div>
    </div>

    <!-- 第三列：月 / 季 / 年 -->
    <div class="form-row mb-2">
      <div class="form-group col-md-12">
        <label class="mr-2">顯示範圍：</label>
        <label class="mr-2"><input type="radio" name="viewType" value="month" checked/>月</label>
        <label class="mr-2"><input type="radio" name="viewType" value="quarter"/>季</label>
        <label class="mr-2"><input type="radio" name="viewType" value="year"/>年</label>
      </div>
    </div>

    <!-- 操作 -->
    <button id="btnQuery" type="button" class="btn btn-primary mr-2">查詢</button>
    <asp:Button ID="btnExport" runat="server" CssClass="btn btn-success" Text="匯出 Excel" OnClick="btnExport_Click" />

    <!-- Thk/Res 列顯示 -->
    <div class="mt-3">
      <label class="mr-2">顯示欄位：</label>
      <label class="mr-2"><input type="checkbox" class="col-toggle" value="col-thk1" checked/>Thk1</label>
      <label class="mr-2"><input type="checkbox" class="col-toggle" value="col-thk2" checked/>Thk2</label>
      <label class="mr-2"><input type="checkbox" class="col-toggle" value="col-thk3" checked/>Thk3</label>
      <label class="mr-2"><input type="checkbox" class="col-toggle" value="col-res1" checked/>Res1</label>
      <label class="mr-2"><input type="checkbox" class="col-toggle" value="col-res2" checked/>Res2</label>
      <label class="mr-2"><input type="checkbox" class="col-toggle" value="col-res3" checked/>Res3</label>
    </div>
  </div>
</div>

<!-- ===== 表頭 + 表身 (水平&垂直可捲) ===== -->
<div class="h-scroll-wrapper table-wrapper">
  <table id="headerTable" class="table table-bordered table-sm mb-0">
    <thead></thead>
  </table>
  <div class="table-responsive">
    <table id="bodyTable" class="table table-bordered table-sm">
      <tbody></tbody>
    </table>
  </div>
</div>
</form>

<script>
/* ---------- 初始化 ---------- */
$(function(){
    $(".datepicker").datepicker({dateFormat:"yy/mm/dd"});
    const y=new Date().getFullYear().toString();
    $(`input[name=year][value=${y}]`).prop("checked",true);

    $("#btnQuery").on("click",queryReport);

    $(".col-toggle").on("change",function(){
        const cls=$(this).val();
        $("th."+cls+", td."+cls).toggle($(this).is(":checked"));
        syncHeaderWidths();
    });

    $(window).on("resize",syncHeaderWidths);
});

/* ---------- AJAX 取得資料 ---------- */
function queryReport(){
    const years=$("input[name=year]:checked").map((_,el)=>+el.value).get();
    if(!years.length){alert("請至少選一年");return;}
    const viewType=$("input[name=viewType]:checked").val();

    $.ajax({
        type:"POST",
        url:"AnnualReport1.aspx/GetReportData",
        contentType:"application/json; charset=utf-8",
        dataType:"json",
        data:JSON.stringify({
            department:$("#ddlDept").val(),
            business:$("#ddlBiz").val(),
            region:$("#ddlRegion").val(),
            yearList:years,
            customer:$("#ddlCustomer").val(),
            custItem:$("#txtCustItem").val(),
            substrate:$("#ddlSubstrate").val(),
            productType:$("#ddlProductType").val(),
            shipTo:$("#txtShipTo").val(),
            realDate:$("#txtRealDate").val(),
            status:$("#ddlStatus").val(),
            orderType:$("#ddlOrderType").val()
        }),
        success:r=>{
            const data=r.d||r;
            buildHeader(years,viewType);
            buildBody(data,years,viewType);
            updateTotals();
            syncHeaderWidths();
            $(".col-toggle").each(function(){
                if(!$(this).is(":checked"))
                    $("th."+this.value+", td."+this.value).hide();
            });
        },
        error:e=>{console.error(e);alert("查詢失敗");}
    });
}

/* ---------- 固定欄定義 ---------- */
const fixedCols=[
  {t:"Customer", c:"col-customer",  w:"w120"},
  {t:"Inch",     c:"col-inch",      w:"w60"},
  {t:"Cust&nbsp;Item", c:"col-custitem", w:"w120"},
  {t:"OA&nbsp;Item",   c:"col-oaitem",   w:"w120"},
  {t:"Substrate",c:"col-substrate", w:"w100"},
  {t:"Price",    c:"col-price",     w:"w80"},
  {t:"Thk1",     c:"col-thk1",      w:"w80"},
  {t:"Res1",     c:"col-res1",      w:"w80"},
  {t:"Thk2",     c:"col-thk2",      w:"w80"},
  {t:"Res2",     c:"col-res2",      w:"w80"},
  {t:"Thk3",     c:"col-thk3",      w:"w80"},
  {t:"Res3",     c:"col-res3",      w:"w80"}
];

/* ---------- buildHeader (與前版一致) ---------- */
/* …完整函式內容照舊，未調整… */

/* ---------- buildBody (與前版一致) ---------- */
/* …完整函式內容照舊，未調整… */

/* ---------- 同步欄寬 ---------- */
function syncHeaderWidths(){
    const $row=$("#bodyTable tbody tr:first");
    if(!$row.length) return;

    const widths=[];
    $row.children().each(function(i){widths[i]=$(this).outerWidth();});
    $("#headerTable thead tr").each(function(){
        $(this).children().each(function(i){
            $(this).css("width",widths[i]);
        });
    });

    const $wrap=$("#bodyTable").closest(".table-responsive")[0];
    const sc=$wrap.offsetWidth-$wrap.clientWidth;
    $("#headerTable").css("margin-right",sc+"px");
}

/* ---------- 合計 (與前版一致) ---------- */
/* …完整函式內容照舊，未調整… */
</script>
</body>
</html>