<%@ Page Language="C#" AutoEventWireup="true" CodeBehind="AnnualReport1.aspx.cs" Inherits="CRM.AnnualReport1" %>

<!DOCTYPE html>
<html lang="zh-TW">
<head runat="server">
<meta charset="utf-8" />
<title>年度查詢報表</title>

<!-- Bootstrap & jQuery -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<!-- jQuery UI：日期選擇器 -->
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" />
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<style>
    /* Sticky 表頭 */
    thead tr.totals-row   th{position:sticky;top:0;   z-index:4;background:#fff;color:#007bff;}
    thead tr:nth-child(2) th{position:sticky;top:48px;z-index:3;background:#f2f2f2;}
    thead tr:nth-child(3) th{position:sticky;top:96px;z-index:2;background:#fafafa;}
    thead tr:nth-child(4) th{position:sticky;top:144px;z-index:1;background:#fff;}

    /* 固定欄位色 */
    .fc-blank{background:#fff!important;}
    .fc      {background:#f2f2f2!important;}

    /* 年度色塊 */
    .year-0{background:#92D050;}
    .year-1{background:#00B0F0;}
    .year-2{background:#FFC000;}
    .year-3{background:#A9A9A9;}

    /* 捲動容器 */
    .table-hscroll{overflow-x:auto;}
    .table-responsive{max-height:700px;overflow-y:auto;}

    /* 儲格寬度限制 + 換行 */
    .table-wrapper th,
    .table-wrapper td{
        min-width:60px;
        max-width:150px;
        white-space:normal;
        word-break:break-word;
    }

    /* 固定寬 class */
    .w120{width:120px;} .w100{width:100px;} .w80{width:80px;} .w60{width:60px;}

    /* 表格外觀 */
    .table thead th{vertical-align:bottom;border-bottom:0;}
    .table-bordered td,.table-bordered th{border:0;}
    .table-sm td,.table-sm th{padding:.75rem;}

    /* 兩表同樣固定布局，寬度由內容決定 */
    #headerTable,#bodyTable{table-layout:fixed;}
</style>
</head>
<body>
<form id="form1" runat="server" class="container-fluid my-3">

<!-- ===== 查詢條件（內容與前版相同，為節省篇幅省略） ===== -->
<!-- …請放回你現有的條件區塊 HTML，不需修改… -->

<!-- ===== 表頭 + 表身 ===== -->
<div class="table-wrapper">
  <div class="table-hscroll"><!-- X 軸同步拖動 -->
      <table id="headerTable" class="table table-bordered table-sm mb-0">
          <thead></thead>
      </table>

      <div class="table-responsive"><!-- 垂直捲動 -->
          <table id="bodyTable" class="table table-bordered table-sm">
              <tbody></tbody>
          </table>
      </div>
  </div>
</div>
</form>

<script>
$(function(){
    /* 初始化 */
    $(".datepicker").datepicker({dateFormat:"yy/mm/dd"});
    const y=new Date().getFullYear().toString();
    $(`input[name=year][value=${y}]`).prop("checked",true);

    $("#btnQuery").on("click",queryReport);

    /* Thk/Res 欄位切換 */
    $(".col-toggle").on("change",function(){
        const cls=$(this).val();
        $("th."+cls+", td."+cls).toggle($(this).is(":checked"));
        syncHeaderWidths();
    });

    /* 視窗大小改變時重新同步 */
    $(window).on("resize",syncHeaderWidths);
});

/* ---------- AJAX 取得資料 ---------- */
function queryReport(){
    const years=$("input[name=year]:checked").map((_,el)=>+el.value).get();
    if(!years.length){alert("請至少選一年");return;}
    const viewType=$("input[name=viewType]:checked").val();

    $.ajax({
        type:"POST",
        url:"AnnualReport1.aspx/GetReportData",
        contentType:"application/json; charset=utf-8",
        dataType:"json",
        data:JSON.stringify({
            department:$("#ddlDept").val(), business:$("#ddlBiz").val(), region:$("#ddlRegion").val(),
            yearList:years, customer:$("#ddlCustomer").val(), custItem:$("#txtCustItem").val(),
            substrate:$("#ddlSubstrate").val(), productType:$("#ddlProductType").val(),
            shipTo:$("#txtShipTo").val(), realDate:$("#txtRealDate").val(),
            status:$("#ddlStatus").val(), orderType:$("#ddlOrderType").val()
        }),
        success:r=>{
            const data=r.d||r;
            buildHeader(years,viewType);
            buildBody(data,years,viewType);
            updateTotals();
            syncHeaderWidths();                 // 重新對齊
            /* 根據勾選狀態隱藏欄位 */
            $(".col-toggle").each(function(){
                if(!$(this).is(":checked"))
                    $("th."+this.value+", td."+this.value).hide();
            });
        },
        error:e=>{console.error(e);alert("查詢失敗");}
    });
}

/* ---------- 固定欄定義 ---------- */
const fixedCols=[ /* 與前版相同，略 */ ];

/* ---------- buildHeader / buildBody  （內容沿用前版，未改動） ---------- */
/* ……請保持你上一版的兩支函式…… */

/* ---------- 合計 ---------- */
function updateTotals(){
    const $rows=$("#bodyTable tbody tr");
    if(!$rows.length) return;
    const cnt=$rows.first().children().length;
    const sums=Array(cnt).fill(0);
    $rows.each(function(){
        $(this).children().each(function(i){
            const v=parseFloat($(this).text().replace(/,/g,""));
            if(!isNaN(v)) sums[i]+=v;
        });
    });
    $("#headerTable thead tr.totals-row").children().each(function(i){
        if(i===0) $(this).text("總計");
        else{
            const v=sums[i];
            $(this).text(v? v.toLocaleString():"");
        }
    });
}

/* ---------- (A) 同步兩表欄寬 + Scrollbar 差 ---------- */
function syncHeaderWidths(){
    const $row=$("#bodyTable tbody tr:first");
    if(!$row.length) return;

    /* 1. 依第一列計算每欄寬 */
    const w=[];
    $row.children().each(function(i){ w[i]=$(this).outerWidth(); });

    $("#headerTable thead tr").each(function(){
        $(this).children().each(function(i){
            $(this).css("width",w[i]);
        });
    });

    /* 2. 考慮垂直捲動條寬度 */
    const wrap=document.querySelector(".table-responsive");
    const sb=wrap.offsetWidth-wrap.clientWidth; // scrollbar width
    $("#headerTable").css("margin-right",sb+"px");
}
</script>
</body>
</html>